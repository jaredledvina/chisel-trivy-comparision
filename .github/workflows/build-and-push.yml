name: Build and Push Images

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-vanilla:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for vanilla image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-vanilla
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Build vanilla image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Get primary tag
        id: primary-tag
        run: |
          PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          echo "tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.primary-tag.outputs.tag }}
          format: 'json'
          output: 'vanilla-trivy-report.json'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.primary-tag.outputs.tag }}
          format: 'table'
          output: 'vanilla-trivy-report.txt'

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.primary-tag.outputs.tag }}
          format: 'sarif'
          output: 'vanilla-trivy-report.sarif'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'vanilla-trivy-report.sarif'
          category: 'vanilla-image'

      - name: Generate vulnerability summary
        run: |
          echo "## Vanilla Image Vulnerability Summary" > vanilla-summary.md
          echo "" >> vanilla-summary.md
          echo "\`\`\`" >> vanilla-summary.md
          cat vanilla-trivy-report.txt >> vanilla-summary.md
          echo "\`\`\`" >> vanilla-summary.md

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vanilla-scan-results
          path: |
            vanilla-trivy-report.json
            vanilla-trivy-report.txt
            vanilla-summary.md

      - name: Push vanilla image to registry
        run: |
          echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r tag; do
            docker push "${tag}"
          done

  build-chiseled:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build rock with Rockcraft
        id: rockcraft
        uses: canonical/craft-actions/rockcraft-pack@main

      - name: Upload rock artifact
        uses: actions/upload-artifact@v4
        with:
          name: rock-file
          path: ${{ steps.rockcraft.outputs.rock }}

      - name: Install skopeo
        run: |
          sudo snap install --devmode --channel edge skopeo

      - name: Import rock to Docker
        run: |
          sudo skopeo --insecure-policy copy oci-archive:${{ steps.rockcraft.outputs.rock }} docker-daemon:rockcraft-local:latest

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for chiseled image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chiseled
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Tag chiseled image
        run: |
          PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          docker tag rockcraft-local:latest ${PRIMARY_TAG}
          echo "PRIMARY_TAG=${PRIMARY_TAG}" >> $GITHUB_ENV

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'json'
          output: 'chiseled-trivy-report.json'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'table'
          output: 'chiseled-trivy-report.txt'

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'sarif'
          output: 'chiseled-trivy-report.sarif'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'chiseled-trivy-report.sarif'
          category: 'chiseled-image'

      - name: Generate vulnerability summary
        run: |
          echo "## Chiseled Image Vulnerability Summary" > chiseled-summary.md
          echo "" >> chiseled-summary.md
          echo "\`\`\`" >> chiseled-summary.md
          cat chiseled-trivy-report.txt >> chiseled-summary.md
          echo "\`\`\`" >> chiseled-summary.md

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chiseled-scan-results
          path: |
            chiseled-trivy-report.json
            chiseled-trivy-report.txt
            chiseled-summary.md

      - name: Push chiseled image
        run: |
          echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r tag; do
            docker tag rockcraft-local:latest "${tag}"
            docker push "${tag}"
          done

  compare-results:
    runs-on: ubuntu-latest
    needs: [build-vanilla, build-chiseled]
    permissions:
      contents: read

    steps:
      - name: Download vanilla scan results
        uses: actions/download-artifact@v4
        with:
          name: vanilla-scan-results
          path: ./vanilla

      - name: Download chiseled scan results
        uses: actions/download-artifact@v4
        with:
          name: chiseled-scan-results
          path: ./chiseled

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate comparison report
        run: |
          cat > compare.sh << 'EOF'
          #!/bin/bash

          # Parse JSON reports to count vulnerabilities by severity
          count_vulns() {
            local file=$1
            local severity=$2
            jq "[.Results[]?.Vulnerabilities[]? | select(.Severity == \"$severity\")] | length" "$file"
          }

          echo "# Trivy Scan Comparison Report" > comparison-report.md
          echo "" >> comparison-report.md
          echo "Comparison of vulnerability scans between vanilla Ubuntu Jammy and chiseled Ubuntu Jammy images." >> comparison-report.md
          echo "" >> comparison-report.md

          # Count vulnerabilities for vanilla
          VANILLA_CRITICAL=$(count_vulns "./vanilla/vanilla-trivy-report.json" "CRITICAL")
          VANILLA_HIGH=$(count_vulns "./vanilla/vanilla-trivy-report.json" "HIGH")
          VANILLA_MEDIUM=$(count_vulns "./vanilla/vanilla-trivy-report.json" "MEDIUM")
          VANILLA_LOW=$(count_vulns "./vanilla/vanilla-trivy-report.json" "LOW")
          VANILLA_TOTAL=$((VANILLA_CRITICAL + VANILLA_HIGH + VANILLA_MEDIUM + VANILLA_LOW))

          # Count vulnerabilities for chiseled
          CHISELED_CRITICAL=$(count_vulns "./chiseled/chiseled-trivy-report.json" "CRITICAL")
          CHISELED_HIGH=$(count_vulns "./chiseled/chiseled-trivy-report.json" "HIGH")
          CHISELED_MEDIUM=$(count_vulns "./chiseled/chiseled-trivy-report.json" "MEDIUM")
          CHISELED_LOW=$(count_vulns "./chiseled/chiseled-trivy-report.json" "LOW")
          CHISELED_TOTAL=$((CHISELED_CRITICAL + CHISELED_HIGH + CHISELED_MEDIUM + CHISELED_LOW))

          echo "## Summary" >> comparison-report.md
          echo "" >> comparison-report.md
          echo "| Image | Critical | High | Medium | Low | Total |" >> comparison-report.md
          echo "|-------|----------|------|--------|-----|-------|" >> comparison-report.md
          echo "| Vanilla Ubuntu Jammy | $VANILLA_CRITICAL | $VANILLA_HIGH | $VANILLA_MEDIUM | $VANILLA_LOW | $VANILLA_TOTAL |" >> comparison-report.md
          echo "| Chiseled Ubuntu Jammy | $CHISELED_CRITICAL | $CHISELED_HIGH | $CHISELED_MEDIUM | $CHISELED_LOW | $CHISELED_TOTAL |" >> comparison-report.md
          echo "" >> comparison-report.md

          # Calculate reduction
          CRITICAL_REDUCTION=$((VANILLA_CRITICAL - CHISELED_CRITICAL))
          HIGH_REDUCTION=$((VANILLA_HIGH - CHISELED_HIGH))
          TOTAL_REDUCTION=$((VANILLA_TOTAL - CHISELED_TOTAL))

          echo "## Vulnerability Reduction" >> comparison-report.md
          echo "" >> comparison-report.md
          echo "- **Critical vulnerabilities reduced by:** $CRITICAL_REDUCTION" >> comparison-report.md
          echo "- **High vulnerabilities reduced by:** $HIGH_REDUCTION" >> comparison-report.md
          echo "- **Total vulnerabilities reduced by:** $TOTAL_REDUCTION" >> comparison-report.md

          if [ $TOTAL_REDUCTION -gt 0 ]; then
            REDUCTION_PERCENT=$(echo "scale=1; $TOTAL_REDUCTION * 100 / $VANILLA_TOTAL" | bc)
            echo "- **Percentage reduction:** ${REDUCTION_PERCENT}%" >> comparison-report.md
          fi

          echo "" >> comparison-report.md
          echo "---" >> comparison-report.md
          echo "" >> comparison-report.md

          cat ./vanilla/vanilla-summary.md >> comparison-report.md
          echo "" >> comparison-report.md
          echo "---" >> comparison-report.md
          echo "" >> comparison-report.md
          cat ./chiseled/chiseled-summary.md >> comparison-report.md
          EOF

          chmod +x compare.sh
          ./compare.sh

      - name: Display comparison report
        run: cat comparison-report.md

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison-report.md

      - name: Comment comparison on commit (if PR exists)
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('comparison-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
