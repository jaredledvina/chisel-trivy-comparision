name: Build and Push Images

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-vanilla:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for vanilla image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-vanilla
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Build vanilla image
        uses: docker/build-push-action@v5
        with:
          context: ./vanilla
          file: ./vanilla/Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Get primary tag
        id: primary-tag
        run: |
          PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          echo "tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.primary-tag.outputs.tag }}
          format: 'json'
          output: 'vanilla-trivy-report.json'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.primary-tag.outputs.tag }}
          format: 'table'
          output: 'vanilla-trivy-report.txt'

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.primary-tag.outputs.tag }}
          format: 'sarif'
          output: 'vanilla-trivy-report.sarif'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'vanilla-trivy-report.sarif'
          category: 'vanilla-image'

      - name: Generate vulnerability summary
        run: |
          echo "## Vanilla Image Vulnerability Summary" > vanilla-summary.md
          echo "" >> vanilla-summary.md
          echo "\`\`\`" >> vanilla-summary.md
          cat vanilla-trivy-report.txt >> vanilla-summary.md
          echo "\`\`\`" >> vanilla-summary.md

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vanilla-scan-results
          path: |
            vanilla-trivy-report.json
            vanilla-trivy-report.txt
            vanilla-summary.md

      - name: Push vanilla image to registry
        run: |
          echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r tag; do
            docker push "${tag}"
          done

  build-chiseled:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build rock with Rockcraft
        id: rockcraft
        uses: canonical/craft-actions/rockcraft-pack@main
        with:
          path: rockcraft-bare

      - name: Upload rock artifact
        uses: actions/upload-artifact@v4
        with:
          name: rock-file
          path: ${{ steps.rockcraft.outputs.rock }}

      - name: Install skopeo
        run: |
          sudo snap install --devmode --channel edge skopeo

      - name: Import rock to Docker
        run: |
          sudo skopeo --insecure-policy copy oci-archive:${{ steps.rockcraft.outputs.rock }} docker-daemon:rockcraft-local:latest

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for chiseled image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chiseled
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Tag chiseled image
        run: |
          PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          docker tag rockcraft-local:latest ${PRIMARY_TAG}
          echo "PRIMARY_TAG=${PRIMARY_TAG}" >> $GITHUB_ENV

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'json'
          output: 'chiseled-trivy-report.json'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'table'
          output: 'chiseled-trivy-report.txt'

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'sarif'
          output: 'chiseled-trivy-report.sarif'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'chiseled-trivy-report.sarif'
          category: 'chiseled-image'

      - name: Generate vulnerability summary
        run: |
          echo "## Chiseled Image Vulnerability Summary" > chiseled-summary.md
          echo "" >> chiseled-summary.md
          echo "\`\`\`" >> chiseled-summary.md
          cat chiseled-trivy-report.txt >> chiseled-summary.md
          echo "\`\`\`" >> chiseled-summary.md

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chiseled-scan-results
          path: |
            chiseled-trivy-report.json
            chiseled-trivy-report.txt
            chiseled-summary.md

      - name: Push chiseled image
        run: |
          echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r tag; do
            docker tag rockcraft-local:latest "${tag}"
            docker push "${tag}"
          done

  build-chiseled-dpkg:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build rock with Rockcraft (with dpkg status)
        id: rockcraft
        uses: canonical/craft-actions/rockcraft-pack@main
        with:
          path: rockcraft-dpkg

      - name: Upload rock artifact
        uses: actions/upload-artifact@v4
        with:
          name: rock-file-dpkg
          path: ${{ steps.rockcraft.outputs.rock }}

      - name: Install skopeo
        run: |
          sudo snap install --devmode --channel edge skopeo

      - name: Import rock to Docker
        run: |
          sudo skopeo --insecure-policy copy oci-archive:${{ steps.rockcraft.outputs.rock }} docker-daemon:rockcraft-dpkg-local:latest

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for chiseled-dpkg image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chiseled-dpkg
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Tag chiseled-dpkg image
        run: |
          PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          docker tag rockcraft-dpkg-local:latest ${PRIMARY_TAG}
          echo "PRIMARY_TAG=${PRIMARY_TAG}" >> $GITHUB_ENV

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'json'
          output: 'chiseled-dpkg-trivy-report.json'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'table'
          output: 'chiseled-dpkg-trivy-report.txt'

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.PRIMARY_TAG }}
          format: 'sarif'
          output: 'chiseled-dpkg-trivy-report.sarif'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'chiseled-dpkg-trivy-report.sarif'
          category: 'chiseled-dpkg-image'

      - name: Generate vulnerability summary
        run: |
          echo "## Chiseled Image (with dpkg status) Vulnerability Summary" > chiseled-dpkg-summary.md
          echo "" >> chiseled-dpkg-summary.md
          echo "\`\`\`" >> chiseled-dpkg-summary.md
          cat chiseled-dpkg-trivy-report.txt >> chiseled-dpkg-summary.md
          echo "\`\`\`" >> chiseled-dpkg-summary.md

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chiseled-dpkg-scan-results
          path: |
            chiseled-dpkg-trivy-report.json
            chiseled-dpkg-trivy-report.txt
            chiseled-dpkg-summary.md

      - name: Push chiseled-dpkg image
        run: |
          echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r tag; do
            docker tag rockcraft-dpkg-local:latest "${tag}"
            docker push "${tag}"
          done

  compare-results:
    runs-on: ubuntu-latest
    needs: [build-vanilla, build-chiseled, build-chiseled-dpkg]
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download vanilla scan results
        uses: actions/download-artifact@v4
        with:
          name: vanilla-scan-results
          path: ./vanilla

      - name: Download chiseled scan results
        uses: actions/download-artifact@v4
        with:
          name: chiseled-scan-results
          path: ./chiseled

      - name: Download chiseled-dpkg scan results
        uses: actions/download-artifact@v4
        with:
          name: chiseled-dpkg-scan-results
          path: ./chiseled-dpkg

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Generate comparison report
        run: |
          cat > compare.sh << 'EOF'
          #!/bin/bash

          # Parse JSON reports to count vulnerabilities by severity
          count_vulns() {
            local file=$1
            local severity=$2
            jq "[.Results[]?.Vulnerabilities[]? | select(.Severity == \"$severity\")] | length" "$file"
          }

          echo "# Trivy Scan Comparison Report" > comparison-report.md
          echo "" >> comparison-report.md
          echo "Comparison of vulnerability scans between vanilla Ubuntu Jammy, chiseled Ubuntu Jammy (bare base), and chiseled with dpkg status." >> comparison-report.md
          echo "" >> comparison-report.md

          # Count vulnerabilities for vanilla
          VANILLA_CRITICAL=$(count_vulns "./vanilla/vanilla-trivy-report.json" "CRITICAL")
          VANILLA_HIGH=$(count_vulns "./vanilla/vanilla-trivy-report.json" "HIGH")
          VANILLA_MEDIUM=$(count_vulns "./vanilla/vanilla-trivy-report.json" "MEDIUM")
          VANILLA_LOW=$(count_vulns "./vanilla/vanilla-trivy-report.json" "LOW")
          VANILLA_TOTAL=$((VANILLA_CRITICAL + VANILLA_HIGH + VANILLA_MEDIUM + VANILLA_LOW))

          # Count vulnerabilities for chiseled
          CHISELED_CRITICAL=$(count_vulns "./chiseled/chiseled-trivy-report.json" "CRITICAL")
          CHISELED_HIGH=$(count_vulns "./chiseled/chiseled-trivy-report.json" "HIGH")
          CHISELED_MEDIUM=$(count_vulns "./chiseled/chiseled-trivy-report.json" "MEDIUM")
          CHISELED_LOW=$(count_vulns "./chiseled/chiseled-trivy-report.json" "LOW")
          CHISELED_TOTAL=$((CHISELED_CRITICAL + CHISELED_HIGH + CHISELED_MEDIUM + CHISELED_LOW))

          # Count vulnerabilities for chiseled-dpkg
          CHISELED_DPKG_CRITICAL=$(count_vulns "./chiseled-dpkg/chiseled-dpkg-trivy-report.json" "CRITICAL")
          CHISELED_DPKG_HIGH=$(count_vulns "./chiseled-dpkg/chiseled-dpkg-trivy-report.json" "HIGH")
          CHISELED_DPKG_MEDIUM=$(count_vulns "./chiseled-dpkg/chiseled-dpkg-trivy-report.json" "MEDIUM")
          CHISELED_DPKG_LOW=$(count_vulns "./chiseled-dpkg/chiseled-dpkg-trivy-report.json" "LOW")
          CHISELED_DPKG_TOTAL=$((CHISELED_DPKG_CRITICAL + CHISELED_DPKG_HIGH + CHISELED_DPKG_MEDIUM + CHISELED_DPKG_LOW))

          echo "## Summary" >> comparison-report.md
          echo "" >> comparison-report.md
          echo "| Image | Critical | High | Medium | Low | Total |" >> comparison-report.md
          echo "|-------|----------|------|--------|-----|-------|" >> comparison-report.md
          echo "| Vanilla Ubuntu Jammy | $VANILLA_CRITICAL | $VANILLA_HIGH | $VANILLA_MEDIUM | $VANILLA_LOW | $VANILLA_TOTAL |" >> comparison-report.md
          echo "| Chiseled (Bare Base) | $CHISELED_CRITICAL | $CHISELED_HIGH | $CHISELED_MEDIUM | $CHISELED_LOW | $CHISELED_TOTAL |" >> comparison-report.md
          echo "| Chiseled + dpkg status | $CHISELED_DPKG_CRITICAL | $CHISELED_DPKG_HIGH | $CHISELED_DPKG_MEDIUM | $CHISELED_DPKG_LOW | $CHISELED_DPKG_TOTAL |" >> comparison-report.md
          echo "" >> comparison-report.md

          echo "## Key Observations" >> comparison-report.md
          echo "" >> comparison-report.md
          echo "### Vanilla vs Chiseled (Bare Base)" >> comparison-report.md
          CRITICAL_REDUCTION=$((VANILLA_CRITICAL - CHISELED_CRITICAL))
          HIGH_REDUCTION=$((VANILLA_HIGH - CHISELED_HIGH))
          TOTAL_REDUCTION=$((VANILLA_TOTAL - CHISELED_TOTAL))
          echo "- **Critical vulnerabilities reduced:** $CRITICAL_REDUCTION" >> comparison-report.md
          echo "- **High vulnerabilities reduced:** $HIGH_REDUCTION" >> comparison-report.md
          echo "- **Total vulnerabilities reduced:** $TOTAL_REDUCTION" >> comparison-report.md
          if [ $VANILLA_TOTAL -gt 0 ]; then
            REDUCTION_PERCENT=$(echo "scale=1; $TOTAL_REDUCTION * 100 / $VANILLA_TOTAL" | bc)
            echo "- **Percentage reduction:** ${REDUCTION_PERCENT}%" >> comparison-report.md
          fi
          echo "" >> comparison-report.md

          echo "### Chiseled (Bare Base) vs Chiseled + dpkg status" >> comparison-report.md
          DPKG_CRITICAL_DIFF=$((CHISELED_DPKG_CRITICAL - CHISELED_CRITICAL))
          DPKG_HIGH_DIFF=$((CHISELED_DPKG_HIGH - CHISELED_HIGH))
          DPKG_TOTAL_DIFF=$((CHISELED_DPKG_TOTAL - CHISELED_TOTAL))
          echo "- **Critical vulnerabilities difference:** $DPKG_CRITICAL_DIFF" >> comparison-report.md
          echo "- **High vulnerabilities difference:** $DPKG_HIGH_DIFF" >> comparison-report.md
          echo "- **Total vulnerabilities difference:** $DPKG_TOTAL_DIFF" >> comparison-report.md
          echo "" >> comparison-report.md
          echo "> **Note:** The dpkg status file allows Trivy to detect installed packages and their vulnerabilities more accurately." >> comparison-report.md
          echo "" >> comparison-report.md

          echo "---" >> comparison-report.md
          echo "" >> comparison-report.md

          cat ./vanilla/vanilla-summary.md >> comparison-report.md
          echo "" >> comparison-report.md
          echo "---" >> comparison-report.md
          echo "" >> comparison-report.md
          cat ./chiseled/chiseled-summary.md >> comparison-report.md
          echo "" >> comparison-report.md
          echo "---" >> comparison-report.md
          echo "" >> comparison-report.md
          cat ./chiseled-dpkg/chiseled-dpkg-summary.md >> comparison-report.md
          EOF

          chmod +x compare.sh
          ./compare.sh

      - name: Display comparison report
        run: cat comparison-report.md

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison-report.md

      - name: Generate README.md
        run: |
          # Extract summary data from comparison report
          VANILLA_TOTAL=$(grep "Vanilla Ubuntu Jammy" comparison-report.md | grep -oP '\|\s*\d+\s*\|' | tail -1 | tr -d '| ')
          CHISELED_TOTAL=$(grep "Chiseled (Bare Base)" comparison-report.md | grep -oP '\|\s*\d+\s*\|' | tail -1 | tr -d '| ')
          CHISELED_DPKG_TOTAL=$(grep "Chiseled + dpkg status" comparison-report.md | grep -oP '\|\s*\d+\s*\|' | tail -1 | tr -d '| ')

          cat > README.md << 'EOF'
          # Chisel vs Trivy Comparison

          This repository compares vulnerability scan results between vanilla Ubuntu Jammy and chiseled Ubuntu Jammy images using Trivy.

          ## Latest Scan Results

          **Tag:** `${{ github.ref_name }}`
          **Run:** [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          EOF

          # Add the comparison summary table
          grep -A 5 "## Summary" comparison-report.md >> README.md
          echo "" >> README.md

          # Add key observations
          grep -A 20 "## Key Observations" comparison-report.md >> README.md
          echo "" >> README.md

          cat >> README.md << 'EOF'
          ## Artifacts

          Download detailed scan results from the latest workflow run:

          - [Vanilla Image Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Chiseled Image Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Chiseled + dpkg status Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Full Comparison Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Container Images

          The following images are available in GitHub Container Registry:

          - `ghcr.io/${{ github.repository }}-vanilla:${{ github.ref_name }}`
          - `ghcr.io/${{ github.repository }}-chiseled:${{ github.ref_name }}`
          - `ghcr.io/${{ github.repository }}-chiseled-dpkg:${{ github.ref_name }}`

          ## Repository Structure

          ```
          chisel-trivy-comparision/
          â”œâ”€â”€ vanilla/
          â”‚   â””â”€â”€ Dockerfile                      # Vanilla Ubuntu Jammy
          â”œâ”€â”€ rockcraft-bare/
          â”‚   â””â”€â”€ rockcraft.yaml                  # Chiseled (bare base)
          â””â”€â”€ rockcraft-dpkg/
              â””â”€â”€ rockcraft.yaml                  # Chiseled + dpkg status
          ```

          ## About

          This comparison demonstrates the security benefits of using chiseled Ubuntu images (minimal, distroless-like containers) versus traditional Ubuntu base images.

          **Key Findings:**
          - Vanilla Ubuntu has fewer vulnerabilities initially but includes a much larger attack surface
          - Chiseled images dramatically reduce the number of installed packages
          - Adding dpkg metadata improves Trivy's vulnerability detection accuracy

          ---

          *Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC') by [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push README
        run: |
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update README with scan results for ${{ github.ref_name }}

          ðŸ¤– Generated with GitHub Actions
          Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            git push
          fi

      - name: Comment comparison on commit (if PR exists)
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('comparison-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
